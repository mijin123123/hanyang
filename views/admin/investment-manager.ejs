<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì ê´€ë¦¬ - í•œì–‘ì—ë„ˆì§€ ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <%- include('../partials/admin-sidebar', { currentPage: 'investment-manager' }) %>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content">
        <!-- í—¤ë” -->
        <header class="admin-header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>íˆ¬ì ê´€ë¦¬</h1>
            </div>
            <div class="header-right">
                <span class="admin-info" id="adminInfo">ê´€ë¦¬ìë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</span>
                <select id="statusFilter" onchange="filterInvestments()" style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="all">ì „ì²´</option>
                    <option value="pending">ìŠ¹ì¸ëŒ€ê¸°</option>
                    <option value="approved">ìŠ¹ì¸ì™„ë£Œ</option>
                    <option value="rejected">ë°˜ë ¤</option>
                </select>
                <button class="btn btn-primary" onclick="exportInvestments()">
                    <i class="fas fa-download"></i> íˆ¬ì ë‚´ì—­ ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </header>

        <!-- íˆ¬ì ê´€ë¦¬ ì»¨í…ì¸  -->
        <div class="dashboard-content">
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3>ì´ íˆ¬ìê¸ˆì•¡</h3>
                        <p class="stat-number">0ì›</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>íˆ¬ìì ìˆ˜</h3>
                        <p class="stat-number">0ëª…</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>ìŠ¹ì¸ëŒ€ê¸°</h3>
                        <p class="stat-number">0ê±´</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>ì´ë²ˆ ë‹¬ íˆ¬ì</h3>
                        <p class="stat-number">0ì›</p>
                    </div>
                </div>
            </div>

            <!-- íˆ¬ì ëª©ë¡ -->
            <div class="admin-table">
                <table id="investmentTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 0)">ë²ˆí˜¸</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 1)">íˆ¬ìì</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 2)">ìƒí’ˆëª…</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 3, 'number')">íˆ¬ìê¸ˆì•¡</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 4)">ì‹ ì²­ì¼</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 5)">ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="investmentTableBody">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </tbody>
                </table>
            </div>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="paginationContainer"></div>
        </div>
    </div>

    <script src="/admin/js/admin.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // ë¡œê·¸ì¸ ì²´í¬
        checkAdminAuth();
        
        // ê´€ë¦¬ì ì •ë³´ í‘œì‹œ
        const currentAdmin = getCurrentAdmin();
        if (currentAdmin) {
            document.getElementById('adminInfo').textContent = `${currentAdmin.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
        }

        // íˆ¬ì ë°ì´í„° ë³€ìˆ˜
        let investments = [];
        let filteredInvestments = [];

        // íˆ¬ì ë°ì´í„° ë¡œë“œ
        async function loadInvestments() {
            try {
                const response = await fetch('/api/admin/investments', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    investments = result.investments.map(inv => {
                        console.log('ğŸ” íˆ¬ì ë°ì´í„° ì›ë³¸:', inv); // ë””ë²„ê·¸ìš©
                        
                        // ëª¨ë“  ê°€ëŠ¥í•œ ì»¬ëŸ¼ëª… ì‹œë„
                        const productName = inv.product_name || inv.product_type || inv.type || inv.product || 'ì•Œ ìˆ˜ ì—†ìŒ';
                        const amount = parseFloat(
                            inv.investment_amount || 
                            inv.amount || 
                            inv.invest_amount || 
                            inv.money || 
                            0
                        );
                        
                        return {
                            id: inv.id,
                            investor: inv.member?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                            investorUsername: inv.member?.username || '',
                            product: productName,
                            amount: amount,
                            applicationDate: inv.created_at?.split('T')[0] || '',
                            status: inv.status,
                            email: inv.member?.email || '',
                            phone: inv.member?.phone || '',
                            bankName: '',
                            accountNumber: '',
                            adminNote: '',
                            processedAt: inv.updated_at?.split('T')[0] || ''
                        };
                    });
                    
                    filteredInvestments = [...investments];
                    updateInvestmentStats();
                    renderInvestmentTable();
                } else {
                    console.error('íˆ¬ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', result.message);
                    showAlert('error', 'íˆ¬ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('íˆ¬ì ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                showAlert('error', 'íˆ¬ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒí’ˆ íƒ€ì…ì„ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
        function getProductName(productType) {
            const productNames = {
                '300kw': '[300KW] ë‹¤í•¨ê»˜ ë™í–‰ ë‰´ë² ì´ì§',
                '500kw': '[500KW] ë‹¤í•¨ê»˜ ë™í–‰',
                '1mw': '[1MW] ë‹¤í•¨ê»˜ ë™í–‰ ë©”ê°€',
                'green_starter': 'ê·¸ë¦° ìŠ¤íƒ€í„° íŒ¨í‚¤ì§€',
                'laon': 'ë¼ì˜¨ ì—ë„ˆì§€ íŒ¨í‚¤ì§€',
                'simple_eco': 'ì‹¬í”Œ ì—ì½” íŒ¨í‚¤ì§€'
            };
            return productNames[productType] || productType;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateInvestmentStats() {
            // ì´ íˆ¬ìê¸ˆì•¡
            const totalAmount = investments.reduce((sum, inv) => sum + inv.amount, 0);
            document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = totalAmount.toLocaleString() + 'ì›';
            
            // íˆ¬ìì ìˆ˜ (ì¤‘ë³µ ì œê±°)
            const uniqueInvestors = new Set(investments.map(inv => inv.investor)).size;
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = uniqueInvestors + 'ëª…';
            
            // ìŠ¹ì¸ëŒ€ê¸°
            const pendingCount = investments.filter(inv => inv.status === 'pending').length;
            document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = pendingCount + 'ê±´';
            
            // ì´ë²ˆ ë‹¬ íˆ¬ì (2025ë…„ 1ì›”)
            const thisMonthInvestments = investments.filter(inv => inv.applicationDate.startsWith('2025-01'));
            const thisMonthAmount = thisMonthInvestments.reduce((sum, inv) => sum + inv.amount, 0);
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = thisMonthAmount.toLocaleString() + 'ì›';
        }

        // íˆ¬ì ëª©ë¡ ë Œë”ë§
        function renderInvestmentTable(data = filteredInvestments) {
            const tbody = document.getElementById('investmentTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 40px;">íˆ¬ì ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            tbody.innerHTML = '';

            data.forEach(investment => {
                const row = document.createElement('tr');
                let statusClass = '';
                let statusText = '';
                
                switch(investment.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'ìŠ¹ì¸ëŒ€ê¸°';
                        break;
                    case 'approved':
                        statusClass = 'status-active';
                        statusText = 'ìŠ¹ì¸ì™„ë£Œ';
                        break;
                    case 'rejected':
                        statusClass = 'status-inactive';
                        statusText = 'ë°˜ë ¤';
                        break;
                }
                
                row.innerHTML = `
                    <td>${investment.id}</td>
                    <td>${investment.investor}</td>
                    <td>${investment.product}</td>
                    <td>${investment.amount.toLocaleString()}ì›</td>
                    <td>${investment.applicationDate}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewInvestment(${investment.id})">
                            <i class="fas fa-eye"></i> ìƒì„¸ë³´ê¸°
                        </button>
                        ${investment.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="approveInvestment(${investment.id})">
                                <i class="fas fa-check"></i> ìŠ¹ì¸
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectInvestment(${investment.id})">
                                <i class="fas fa-times"></i> ë°˜ë ¤
                            </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // íˆ¬ì ìƒì„¸ë³´ê¸°
        function viewInvestment(id) {
            const investment = investments.find(i => i.id === id);
            if (investment) {
                alert(`íˆ¬ì ìƒì„¸ ì •ë³´:\n\níˆ¬ìì: ${investment.investor}\nì´ë©”ì¼: ${investment.email || 'N/A'}\nì—°ë½ì²˜: ${investment.phone || 'N/A'}\nìƒí’ˆëª…: ${investment.product}\níˆ¬ìê¸ˆì•¡: ${investment.amount.toLocaleString()}ì›\nì€í–‰: ${investment.bankName || 'N/A'}\nê³„ì¢Œë²ˆí˜¸: ${investment.accountNumber || 'N/A'}\nì‹ ì²­ì¼: ${investment.applicationDate}\nìƒíƒœ: ${getStatusText(investment.status)}`);
            }
        }

        // íˆ¬ì ìŠ¹ì¸
        async function approveInvestment(id) {
            if (confirm('ì´ íˆ¬ìë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const response = await fetch(`/api/admin/investment/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            action: 'approve',
                            note: 'ê´€ë¦¬ìì— ì˜í•´ ìŠ¹ì¸ë¨'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('success', 'íˆ¬ìê°€ ì„±ê³µì ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        await loadInvestments(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    } else {
                        showAlert('error', result.message || 'íˆ¬ì ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('íˆ¬ì ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                    showAlert('error', 'íˆ¬ì ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // íˆ¬ì ë°˜ë ¤
        async function rejectInvestment(id) {
            if (confirm('ì´ íˆ¬ìë¥¼ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const response = await fetch(`/api/admin/investment/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            action: 'reject',
                            note: 'ê´€ë¦¬ìì— ì˜í•´ ê±°ë¶€ë¨'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('success', 'íˆ¬ìê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        await loadInvestments(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    } else {
                        showAlert('error', result.message || 'íˆ¬ì ë°˜ë ¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('íˆ¬ì ë°˜ë ¤ ì¤‘ ì˜¤ë¥˜:', error);
                    showAlert('error', 'íˆ¬ì ë°˜ë ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // íˆ¬ì í•„í„°ë§
        function filterInvestments() {
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredInvestments = investments.filter(investment => {
                return statusFilter === 'all' || investment.status === statusFilter;
            });
            
            renderInvestmentTable(filteredInvestments);
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'ìŠ¹ì¸ëŒ€ê¸°';
                case 'approved': return 'ìŠ¹ì¸ì™„ë£Œ';
                case 'rejected': return 'ë°˜ë ¤';
                default: return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }

        // íˆ¬ì ë‚´ì—­ ë‚´ë³´ë‚´ê¸°
        function exportInvestments() {
            const csv = generateInvestmentCSV();
            downloadCSV(csv, 'investments.csv');
            showAlert('success', 'íˆ¬ì ë‚´ì—­ì´ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
        }

        // CSV ìƒì„±
        function generateInvestmentCSV() {
            const headers = ['ë²ˆí˜¸', 'íˆ¬ìì', 'ìƒí’ˆëª…', 'íˆ¬ìê¸ˆì•¡', 'ì‹ ì²­ì¼', 'ìƒíƒœ'];
            const rows = filteredInvestments.map(investment => [
                investment.id,
                investment.investor,
                investment.product,
                investment.amount,
                investment.applicationDate,
                getStatusText(investment.status)
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(type, message) {
            // ê°„ë‹¨í•œ ì•Œë¦¼ - ì‹¤ì œë¡œëŠ” ë” ë‚˜ì€ UI ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¶Œì¥
            if (type === 'success') {
                alert('âœ… ' + message);
            } else if (type === 'error') {
                alert('âŒ ' + message);
            } else {
                alert(message);
            }
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadInvestments(); // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
        });
    </script>

    <style>
        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* ë²„íŠ¼ í¬ê¸° */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }

        /* í…Œì´ë¸” í—¤ë” ì •ë ¬ ê°€ëŠ¥ í‘œì‹œ */
        th {
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #e9ecef;
        }

        /* ê´€ë¦¬ì ì •ë³´ ìŠ¤íƒ€ì¼ */
        .admin-info {
            color: #2c3e50;
            font-weight: 500;
            margin-right: 15px;
            padding: 8px 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 5px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }
    </style>
</body>
</html>
