<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 관리 | 한양에너지 관리자</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="../js/auth.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- 사이드바 -->
        <nav class="admin-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-cog"></i> 한양에너지 관리자</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> 대시보드</a></li>
                <li><a href="member-manager.html" class="active"><i class="fas fa-users"></i> 회원 관리</a></li>
                <li><a href="approval-manager.html"><i class="fas fa-user-check"></i> 회원 승인</a></li>
                <li><a href="investment-manager.html"><i class="fas fa-chart-bar"></i> 투자 관리</a></li>
                <li><a href="popup-manager.html"><i class="fas fa-bell"></i> 팝업 관리</a></li>
                <li><a href="account-manager.html"><i class="fas fa-user-cog"></i> 계정 관리</a></li>
                <li><a href="notice-manager.html"><i class="fas fa-bullhorn"></i> 공지사항</a></li>
                <li><a href="inquiry-manager.html"><i class="fas fa-envelope"></i> 문의 관리</a></li>
                <li><a href="../index.html"><i class="fas fa-home"></i> 메인사이트</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </nav>

        <!-- 메인 컨텐츠 -->
        <main class="admin-main">
            <div class="admin-header">
                <h1><i class="fas fa-users"></i> 회원 관리</h1>
                <div class="admin-user-info">
                    <span id="adminName">로딩중...</span>
                    <button onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </button>
                </div>
            </div>

            <div class="admin-content">
                <!-- 통계 카드 -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalMembers">0</h3>
                            <p>총 회원수</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pendingMembers">0</h3>
                            <p>승인 대기</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon approved">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="activeMembers">0</h3>
                            <p>활성 회원</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="investmentMembers">0</h3>
                            <p>투자 회원</p>
                        </div>
                    </div>
                </div>

            <!-- 승인 대기 회원 섹션 -->
            <div class="admin-section" style="margin-bottom: 30px;">
                <div class="section-header">
                    <h2 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-user-clock"></i> 승인 대기 회원
                    </h2>
                    <button class="btn btn-primary" onclick="refreshPendingMembers()">
                        <i class="fas fa-sync"></i> 새로고침
                    </button>
                    <button class="btn btn-info" onclick="testAddPendingMember()" style="margin-left: 10px;">
                        <i class="fas fa-plus"></i> 테스트 회원 추가
                    </button>
                </div>
                
                <div class="admin-table">
                    <table id="pendingMemberTable">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>이름</th>
                                <th>아이디</th>
                                <th>이메일</th>
                                <th>연락처</th>
                                <th>가입일</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="pendingMemberTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #666; padding: 20px;">
                                    승인 대기 회원을 불러오는 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

                <!-- 승인된 회원 목록 -->
                <div class="table-container">
                    <div class="table-header">
                        <h2><i class="fas fa-users"></i> 승인된 회원 목록</h2>
                        <div class="table-actions">
                            <input type="text" id="searchInput" placeholder="이름이나 아이디로 검색..." class="search-input">
                            <button class="btn btn-info" onclick="checkLocalStorageData()">
                                <i class="fas fa-database"></i> 데이터 확인
                            </button>
                            <button class="btn btn-primary" onclick="exportMembers()">
                                <i class="fas fa-download"></i> 내보내기
                            </button>
                            <button class="btn btn-secondary" onclick="refreshApprovedMembers()">
                                <i class="fas fa-sync"></i> 새로고침
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>이름</th>
                                    <th>아이디</th>
                                    <th>연락처</th>
                                    <th>권한</th>
                                    <th>가입일</th>
                                    <th>상태</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="memberTableBody">
                                <tr>
                                    <td colspan="8" class="loading">데이터를 불러오는 중...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 전역 변수
        let approvedMembers = [];

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('회원 관리 페이지 로드됨');
            
            // 관리자 권한 체크
            if (!checkAdminAuth()) {
                return;
            }

            // 관리자 정보 표시
            const admin = getCurrentUser();
            if (admin) {
                document.getElementById('adminName').textContent = admin.name + ' 관리자';
            }

            // 데이터 로드
            loadData();

            // 검색 기능 설정
            setupSearch();
        });

        // 데이터 로드
        async function loadData() {
            await loadPendingMembers();
            await loadApprovedMembers();
            updateStats();
        }

        // 승인 대기 회원 로드
        async function loadPendingMembers() {
            try {
                console.log('승인 대기 회원 로드 시작...'); // 디버깅
                
                // localStorage 직접 확인
                const storedPending = JSON.parse(localStorage.getItem('pendingMembers') || '[]');
                console.log('localStorage에서 가져온 대기 회원:', storedPending); // 디버깅
                
                const pendingMembers = await getPendingMembers();
                console.log('getPendingMembers() 결과:', pendingMembers); // 디버깅
                
                renderPendingMemberTable(pendingMembers);
            } catch (error) {
                console.error('승인 대기 회원 로드 실패:', error);
                document.getElementById('pendingMemberTableBody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">승인 대기 회원을 불러오는 중 오류가 발생했습니다.</td></tr>';
            }
        }

        // 승인 대기 회원 테이블 렌더링
        function renderPendingMemberTable(pendingMembers) {
            const tbody = document.getElementById('pendingMemberTableBody');
            
            if (pendingMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">승인 대기 중인 회원이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = pendingMembers.map((member, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${member.name}</td>
                    <td>${member.username}</td>
                    <td>${member.email}</td>
                    <td>${member.phone || '-'}</td>
                    <td>${formatDate(member.created_at)}</td>
                    <td>
                        <span class="status-badge status-pending">
                            <i class="fas fa-clock"></i> 대기중
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="quickApproveMember('${member.id}')" title="승인">
                            <i class="fas fa-check"></i> 승인
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="quickRejectMember('${member.id}')" title="거부">
                            <i class="fas fa-times"></i> 거부
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewPendingMemberDetail('${member.id}')" title="상세보기">
                            <i class="fas fa-eye"></i> 상세
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 승인된 회원 로드
        async function loadApprovedMembers() {
            console.log('승인된 회원 로드 중...');
            
            // users 배열에서 승인된 회원들 가져오기
            approvedMembers = users.filter(user => user.status === 'approved');
            
            // localStorage에서 승인된 회원들도 추가
            const storedApproved = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
            storedApproved.forEach(member => {
                if (!approvedMembers.find(existing => existing.id === member.id)) {
                    approvedMembers.push(member);
                }
            });
            
            console.log('승인된 회원 목록:', approvedMembers);
            renderApprovedMemberTable();
        }

        // 승인된 회원 테이블 렌더링
        function renderApprovedMemberTable() {
            const tbody = document.getElementById('memberTableBody');
            
            if (approvedMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">승인된 회원이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = approvedMembers.map(member => {
                const roleClass = member.role === 'admin' ? 'role-admin' : 'role-user';
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                
                return `
                    <tr>
                        <td>${member.id}</td>
                        <td>${member.name}</td>
                        <td>${member.username}</td>
                        <td>${member.phone || '-'}</td>
                        <td>
                            <span class="role-badge ${roleClass}">
                                ${roleText}
                            </span>
                        </td>
                        <td>${formatDate(member.approved_at || member.created_at || '2024-03-15')}</td>
                        <td>
                            <span class="status-badge status-active">
                                <i class="fas fa-check-circle"></i> 활성
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewMemberDetail('${member.id}')" title="상세보기">
                                <i class="fas fa-eye"></i> 상세
                            </button>
                            ${member.role !== 'admin' ? `
                                <button class="btn btn-warning btn-sm" onclick="toggleMemberStatus('${member.id}')" title="상태변경">
                                    <i class="fas fa-user-cog"></i> 상태변경
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 통계 업데이트
        async function updateStats() {
            const pendingMembers = await getPendingMembers();
            
            // 총 회원수 (승인된 + 대기중)
            document.getElementById('totalMembers').textContent = approvedMembers.length + pendingMembers.length;
            
            // 승인 대기
            document.getElementById('pendingMembers').textContent = pendingMembers.length;
            
            // 활성 회원
            document.getElementById('activeMembers').textContent = approvedMembers.length;
            
            // 투자 회원 (투자금액이 있는 회원)
            const investmentMembers = approvedMembers.filter(member => 
                member.investmentAmount && member.investmentAmount > 0
            ).length;
            document.getElementById('investmentMembers').textContent = investmentMembers;
        }

        // 빠른 승인
        async function quickApproveMember(memberId) {
            if (confirm('이 회원을 승인하시겠습니까?')) {
                try {
                    const result = await approveMember(memberId, 'approved');
                    if (result.success) {
                        alert('회원이 성공적으로 승인되었습니다.');
                        loadData(); // 전체 데이터 새로고침
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('승인 처리 오류:', error);
                    alert('승인 처리 중 오류가 발생했습니다.');
                }
            }
        }

        // 빠른 거부
        async function quickRejectMember(memberId) {
            const reason = prompt('거부 사유를 입력해주세요:');
            if (reason && reason.trim()) {
                try {
                    const result = await approveMember(memberId, 'rejected', reason.trim());
                    if (result.success) {
                        alert('회원가입이 거부되었습니다.');
                        loadPendingMembers(); // 목록 새로고침
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('거부 처리 오류:', error);
                    alert('거부 처리 중 오류가 발생했습니다.');
                }
            }
        }

        // 승인 대기 회원 상세보기
        async function viewPendingMemberDetail(memberId) {
            try {
                const pendingMembers = await getPendingMembers();
                const member = pendingMembers.find(m => m.id === memberId);
                if (member) {
                    alert(`승인 대기 회원 상세 정보:

이름: ${member.name}
아이디: ${member.username}
이메일: ${member.email}
연락처: ${member.phone || '미입력'}
주소: ${member.address || '미입력'}
가입일: ${formatDate(member.created_at)}
상태: 승인 대기`);
                } else {
                    alert('회원 정보를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('회원 상세 정보 조회 오류:', error);
                alert('회원 정보 조회 중 오류가 발생했습니다.');
            }
        }

        // 회원 상세보기
        function viewMemberDetail(memberId) {
            const member = approvedMembers.find(m => m.id === memberId);
            if (member) {
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                const investmentText = member.investmentAmount ? member.investmentAmount.toLocaleString() + '원' : '투자 없음';
                
                alert(`회원 상세 정보:

이름: ${member.name}
아이디: ${member.username}
이메일: ${member.email || '미입력'}
연락처: ${member.phone || '미입력'}
권한: ${roleText}
가입일: ${formatDate(member.approved_at || member.created_at || '2024-03-15')}
투자금액: ${investmentText}
주소: ${member.address || '미입력'}`);
            }
        }

        // 회원 상태 변경
        function toggleMemberStatus(memberId) {
            if (confirm('이 회원의 상태를 변경하시겠습니까?')) {
                alert('회원 상태 변경 기능은 추후 구현 예정입니다.');
            }
        }

        // 회원 목록 내보내기
        function exportMembers() {
            const csv = generateMemberCSV();
            downloadCSV(csv, 'approved_members.csv');
            alert('회원 목록이 성공적으로 내보내졌습니다.');
        }

        // CSV 생성
        function generateMemberCSV() {
            const headers = ['ID', '이름', '아이디', '이메일', '연락처', '권한', '가입일', '상태'];
            const rows = approvedMembers.map(member => [
                member.id,
                member.name,
                member.username,
                member.email || '',
                member.phone || '',
                member.role === 'admin' ? '관리자' : '사용자',
                formatDate(member.approved_at || member.created_at || '2024-03-15'),
                '활성'
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // CSV 다운로드
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 새로고침 함수들
        function refreshPendingMembers() {
            loadPendingMembers();
            alert('승인 대기 회원 목록을 새로고침했습니다.');
        }

        function refreshApprovedMembers() {
            loadApprovedMembers();
            alert('승인된 회원 목록을 새로고침했습니다.');
        }

        // 검색 기능 설정
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredMembers = approvedMembers.filter(member => 
                        member.name.toLowerCase().includes(searchTerm) ||
                        member.username.toLowerCase().includes(searchTerm) ||
                        (member.email && member.email.toLowerCase().includes(searchTerm))
                    );
                    renderFilteredMemberTable(filteredMembers);
                });
            }
        }

        // 필터된 회원 테이블 렌더링
        function renderFilteredMemberTable(filteredMembers) {
            const tbody = document.getElementById('memberTableBody');
            
            if (filteredMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">검색 결과가 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredMembers.map(member => {
                const roleClass = member.role === 'admin' ? 'role-admin' : 'role-user';
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                
                return `
                    <tr>
                        <td>${member.id}</td>
                        <td>${member.name}</td>
                        <td>${member.username}</td>
                        <td>${member.phone || '-'}</td>
                        <td>
                            <span class="role-badge ${roleClass}">
                                ${roleText}
                            </span>
                        </td>
                        <td>${formatDate(member.approved_at || member.created_at || '2024-03-15')}</td>
                        <td>
                            <span class="status-badge status-active">
                                <i class="fas fa-check-circle"></i> 활성
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewMemberDetail('${member.id}')" title="상세보기">
                                <i class="fas fa-eye"></i> 상세
                            </button>
                            ${member.role !== 'admin' ? `
                                <button class="btn btn-warning btn-sm" onclick="toggleMemberStatus('${member.id}')" title="상태변경">
                                    <i class="fas fa-user-cog"></i> 상태변경
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // 관리자 권한 체크
        function checkAdminAuth() {
            const user = getCurrentUser();
            if (!user || user.role !== 'admin') {
                alert('관리자 권한이 필요합니다.');
                window.location.href = '../login.html';
                return false;
            }
            return true;
        }

        // 테스트용 대기 회원 추가 함수
        function testAddPendingMember() {
            const testMember = {
                id: Date.now().toString(),
                username: 'test_' + Date.now(),
                name: '테스트 회원',
                email: 'test@example.com',
                phone: '010-1234-5678',
                address: '서울시 테스트구',
                status: 'pending',
                created_at: new Date().toISOString()
            };

            // localStorage에 추가
            const storedPending = JSON.parse(localStorage.getItem('pendingMembers') || '[]');
            storedPending.push(testMember);
            localStorage.setItem('pendingMembers', JSON.stringify(storedPending));
            
            console.log('테스트 회원 추가됨:', testMember);
            alert('테스트 회원이 추가되었습니다: ' + testMember.name);
            
            // 목록 새로고침
            loadPendingMembers();
        }

        // localStorage 데이터 확인 함수
        function checkLocalStorageData() {
            const pending = JSON.parse(localStorage.getItem('pendingMembers') || '[]');
            const approved = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
            
            console.log('localStorage 승인 대기 회원:', pending);
            console.log('localStorage 승인된 회원:', approved);
            
            alert(`저장된 데이터:
승인 대기: ${pending.length}명
승인됨: ${approved.length}명

자세한 내용은 콘솔을 확인하세요.`);
        }
    </script>

    <style>
        /* 승인 대기 상태 배지 */
        .status-pending {
            background-color: #ffc107;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        /* 권한 배지 */
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .role-admin {
            background-color: #e74c3c;
            color: white;
        }

        .role-user {
            background-color: #3498db;
            color: white;
        }

        /* 상태 배지 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            color: white;
        }

        .status-badge.status-active {
            background-color: #28a745;
        }

        /* 테이블 액션 */
        .table-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
        }

        /* 버튼 크기 조정 */
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin: 0 2px;
        }

        /* 승인/거부 버튼 색상 */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        /* 통계 카드 아이콘 색상 */
        .pending { background: #ffc107; }
        .approved { background: #28a745; }

        /* 로딩 및 빈 데이터 스타일 */
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        /* 섹션 헤더 */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 관리자 섹션 여백 */
        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</body>
</html>
