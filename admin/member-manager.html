<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 관리 - 한양에너지 관리자</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-tachometer-alt"></i> 관리자</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> 대시보드</a></li>
                <li><a href="popup-manager.html"><i class="fas fa-images"></i> 팝업 관리</a></li>
                <li><a href="notice-manager.html"><i class="fas fa-bullhorn"></i> 공지사항 관리</a></li>
                <li><a href="inquiry-manager.html"><i class="fas fa-envelope"></i> 문의 관리</a></li>
                <li><a href="member-manager.html" class="active"><i class="fas fa-users"></i> 회원 관리</a></li>
                <li><a href="investment-manager.html"><i class="fas fa-chart-line"></i> 투자 관리</a></li>
                <li><a href="account-manager.html"><i class="fas fa-university"></i> 계좌 관리</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> 로그아웃
            </button>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <!-- 헤더 -->
        <header class="admin-header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>회원 관리</h1>
            </div>
            <div class="header-right">
                <span class="admin-info" id="adminInfo">관리자님 환영합니다</span>
                <input type="text" id="searchInput" placeholder="이름이나 이메일로 검색..." style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <button class="btn btn-primary" onclick="exportMembers()">
                    <i class="fas fa-download"></i> 회원 목록 내보내기
                </button>
            </div>
        </header>

        <!-- 회원 관리 컨텐츠 -->
        <div class="dashboard-content">
            <!-- 통계 카드 -->
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>총 회원수</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="stat-info">
                        <h3>신규 회원 (이번 달)</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>활성 회원</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3>투자 회원</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
            </div>

            <!-- 승인 대기 회원 섹션 -->
            <div class="admin-section" style="margin-bottom: 30px;">
                <div class="section-header">
                    <h2 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-user-clock"></i> 승인 대기 회원
                    </h2>
                    <button class="btn btn-primary" onclick="refreshPendingMembers()">
                        <i class="fas fa-sync"></i> 새로고침
                    </button>
                </div>
                
                <div class="admin-table">
                    <table id="pendingMemberTable">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>이름</th>
                                <th>아이디</th>
                                <th>이메일</th>
                                <th>연락처</th>
                                <th>가입일</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="pendingMemberTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #666; padding: 20px;">
                                    승인 대기 회원을 불러오는 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 승인된 회원 목록 -->
            <div class="admin-table">
                <table id="memberTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 0)">ID</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 1)">이름</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 2)">아이디</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 3)">연락처</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 4)">권한</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 5)">가입일</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 6)">상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="memberTableBody">
                        <!-- JavaScript로 동적 생성 -->
                    </tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <div id="paginationContainer"></div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // 로그인 체크
        checkAdminAuth();
        
        // 관리자 정보 표시
        const currentAdmin = getCurrentAdmin();
        if (currentAdmin) {
            document.getElementById('adminInfo').textContent = `${currentAdmin.name}님 환영합니다`;
        }

        // 회원 데이터 (실제 환경에서는 서버에서 가져와야 함)
        let members = [
            {
                id: 1,
                name: "김민정",
                username: "minj0010",
                email: "minj0010@hanyang-energy.com",
                phone: "010-3234-1123",
                joinDate: "2024-03-15",
                status: "active",
                role: "admin",
                investmentAmount: 65000000,
                bankName: "KB국민은행",
                accountNumber: "94401139100103",
                address: "서울 강남구 도산대로 104 (논현동)",
                detailAddress: "원경빌301"
            }
        ];

        // 통계 업데이트 함수
        function updateMemberStats() {
            // 총 회원수
            document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = members.length;
            
            // 신규 회원 (이번 달) - 2024년 3월 기준
            const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM 형식
            const newMembersThisMonth = members.filter(member => member.joinDate.startsWith('2024-03')).length;
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = newMembersThisMonth;
            
            // 활성 회원
            const activeMembers = members.filter(member => member.status === 'active').length;
            document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = activeMembers;
            
            // 투자 회원 (투자금액이 있는 회원)
            const investmentMembers = members.filter(member => member.investmentAmount && member.investmentAmount > 0).length;
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = investmentMembers;
        }

        // 회원 목록 렌더링
        function renderMemberTable() {
            const tbody = document.getElementById('memberTableBody');
            tbody.innerHTML = '';

            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">등록된 회원이 없습니다.</td></tr>';
                return;
            }

            members.forEach(member => {
                const row = document.createElement('tr');
                const statusClass = member.status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = member.status === 'active' ? '활성' : '비활성';
                const roleClass = member.role === 'admin' ? 'role-admin' : 'role-user';
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                
                row.innerHTML = `
                    <td>${member.id}</td>
                    <td>${member.name}</td>
                    <td>${member.username}</td>
                    <td>${member.phone}</td>
                    <td>
                        <span class="role-badge ${roleClass}">
                            ${roleText}
                        </span>
                    </td>
                    <td>${member.joinDate}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewMember(${member.id})">
                            <i class="fas fa-eye"></i> 상세보기
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="toggleMemberStatus(${member.id})">
                            <i class="fas fa-user-cog"></i> 상태변경
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 회원 상세보기
        function viewMember(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                alert(`회원 상세 정보:\n\n이름: ${member.name}\n아이디: ${member.username}\n연락처: ${member.phone}\n권한: ${roleText}\n가입일: ${member.joinDate}\n투자금액: ${member.investmentAmount.toLocaleString()}원\n은행: ${member.bankName}\n계좌번호: ${member.accountNumber}\n주소: ${member.address} ${member.detailAddress}`);
            }
        }

        // 회원 상태 변경
        function toggleMemberStatus(id) {
            const memberIndex = members.findIndex(m => m.id === id);
            if (memberIndex !== -1) {
                const currentStatus = members[memberIndex].status;
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                const statusText = newStatus === 'active' ? '활성화' : '비활성화';
                
                confirmAction(`이 회원을 ${statusText}하시겠습니까?`, () => {
                    members[memberIndex].status = newStatus;
                    renderMemberTable();
                    showAlert('success', `회원이 성공적으로 ${statusText}되었습니다.`);
                });
            }
        }

        // 회원 목록 내보내기
        function exportMembers() {
            const csv = generateMemberCSV();
            downloadCSV(csv, 'members.csv');
            showAlert('success', '회원 목록이 성공적으로 내보내졌습니다.');
        }

        // CSV 생성
        function generateMemberCSV() {
            const headers = ['ID', '이름', '이메일', '연락처', '가입일', '상태', '투자금액'];
            const rows = members.map(member => [
                member.id,
                member.name,
                member.email,
                member.phone,
                member.joinDate,
                member.status === 'active' ? '활성' : '비활성',
                member.investmentAmount
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // CSV 다운로드
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateMemberStats();
            renderMemberTable();
            loadPendingMembers(); // 승인 대기 회원 로드
            
            // 검색 기능 설정
            const searchInput = document.getElementById('searchInput');
            const table = document.getElementById('memberTable');
            setupTableSearch(searchInput, table);
        });

        // 승인 대기 회원 로드
        async function loadPendingMembers() {
            try {
                const pendingMembers = await getPendingMembers();
                console.log('승인 대기 회원 로드됨:', pendingMembers);
                renderPendingMemberTable(pendingMembers);
            } catch (error) {
                console.error('승인 대기 회원 로드 실패:', error);
                document.getElementById('pendingMemberTableBody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">승인 대기 회원을 불러오는 중 오류가 발생했습니다.</td></tr>';
            }
        }

        // 승인 대기 회원 테이블 렌더링
        function renderPendingMemberTable(pendingMembers) {
            const tbody = document.getElementById('pendingMemberTableBody');
            
            if (pendingMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">승인 대기 중인 회원이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = pendingMembers.map((member, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${member.name}</td>
                    <td>${member.username}</td>
                    <td>${member.email}</td>
                    <td>${member.phone || '-'}</td>
                    <td>${formatDate(member.created_at)}</td>
                    <td>
                        <span class="status-badge status-pending">
                            <i class="fas fa-clock"></i> 대기중
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="quickApproveMember('${member.id}')" title="승인">
                            <i class="fas fa-check"></i> 승인
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="quickRejectMember('${member.id}')" title="거부">
                            <i class="fas fa-times"></i> 거부
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewPendingMemberDetail('${member.id}')" title="상세보기">
                            <i class="fas fa-eye"></i> 상세
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 빠른 승인
        async function quickApproveMember(memberId) {
            if (confirm('이 회원을 승인하시겠습니까?')) {
                try {
                    const result = await approveMember(memberId, 'approved');
                    if (result.success) {
                        showAlert('success', '회원이 성공적으로 승인되었습니다.');
                        loadPendingMembers(); // 목록 새로고침
                        updateMemberStats(); // 통계 업데이트
                        renderMemberTable(); // 승인된 회원 목록 업데이트
                    } else {
                        showAlert('error', result.message);
                    }
                } catch (error) {
                    console.error('승인 처리 오류:', error);
                    showAlert('error', '승인 처리 중 오류가 발생했습니다.');
                }
            }
        }

        // 빠른 거부
        async function quickRejectMember(memberId) {
            const reason = prompt('거부 사유를 입력해주세요:');
            if (reason && reason.trim()) {
                try {
                    const result = await approveMember(memberId, 'rejected', reason.trim());
                    if (result.success) {
                        showAlert('success', '회원가입이 거부되었습니다.');
                        loadPendingMembers(); // 목록 새로고침
                    } else {
                        showAlert('error', result.message);
                    }
                } catch (error) {
                    console.error('거부 처리 오류:', error);
                    showAlert('error', '거부 처리 중 오류가 발생했습니다.');
                }
            }
        }

        // 승인 대기 회원 상세보기
        async function viewPendingMemberDetail(memberId) {
            try {
                const pendingMembers = await getPendingMembers();
                const member = pendingMembers.find(m => m.id === memberId);
                if (member) {
                    alert(`승인 대기 회원 상세 정보:\n\n이름: ${member.name}\n아이디: ${member.username}\n이메일: ${member.email}\n연락처: ${member.phone || '미입력'}\n주소: ${member.address || '미입력'}\n가입일: ${formatDate(member.created_at)}\n상태: 승인 대기`);
                } else {
                    showAlert('error', '회원 정보를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('회원 상세 정보 조회 오류:', error);
                showAlert('error', '회원 정보 조회 중 오류가 발생했습니다.');
            }
        }

        // 승인 대기 회원 새로고침
        function refreshPendingMembers() {
            loadPendingMembers();
            showAlert('info', '승인 대기 회원 목록을 새로고침했습니다.');
        }

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // Helper 함수들
        function showAlert(type, message) {
            alert(message);
        }

        function confirmAction(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }

        function setupTableSearch(searchInput, table) {
            if (searchInput && table) {
                searchInput.addEventListener('input', function() {
                    const filter = this.value.toLowerCase();
                    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                    
                    for (let i = 0; i < rows.length; i++) {
                        const cells = rows[i].getElementsByTagName('td');
                        let found = false;
                        
                        for (let j = 1; j < 4; j++) { // 이름, 아이디, 연락처 검색
                            if (cells[j] && cells[j].textContent.toLowerCase().includes(filter)) {
                                found = true;
                                break;
                            }
                        }
                        
                        rows[i].style.display = found ? '' : 'none';
                    }
                });
            }
        }
    </script>

    <style>
        /* 승인 대기 상태 배지 */
        .status-pending {
            background-color: #ffc107;
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        /* 섹션 헤더 */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 버튼 크기 조정 */
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin: 0 2px;
        }

        /* 승인/거부 버튼 색상 */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        /* 관리자 섹션 여백 */
        .admin-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>

    <style>
        /* 상태 배지 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* 권한 배지 */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-admin {
            background: #ffeaa7;
            color: #856404;
        }

        .role-user {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* 버튼 크기 */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }

        /* 관리자 정보 스타일 */
        .admin-info {
            color: #2c3e50;
            font-weight: 500;
            margin-right: 15px;
            padding: 8px 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 5px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* 버튼 크기 */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }

        /* 테이블 헤더 정렬 가능 표시 */
        th {
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #e9ecef;
        }
    </style>
</body>
</html>
