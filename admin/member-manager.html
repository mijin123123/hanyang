<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 관리 - 한양에너지 관리자</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-tachometer-alt"></i> 관리자</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-home"></i> 대시보드</a></li>
                <li><a href="popup-manager.html"><i class="fas fa-images"></i> 팝업 관리</a></li>
                <li><a href="notice-manager.html"><i class="fas fa-bullhorn"></i> 공지사항 관리</a></li>
                <li><a href="inquiry-manager.html"><i class="fas fa-envelope"></i> 문의 관리</a></li>
                <li><a href="member-manager.html" class="active"><i class="fas fa-users"></i> 회원 관리</a></li>
                <li><a href="investment-manager.html"><i class="fas fa-chart-line"></i> 투자 관리</a></li>
                <li><a href="account-manager.html"><i class="fas fa-university"></i> 계좌 관리</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> 로그아웃
            </button>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <!-- 헤더 -->
        <header class="admin-header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>회원 관리</h1>
            </div>
            <div class="header-right">
                <span class="admin-info" id="adminInfo">관리자님 환영합니다</span>
                <input type="text" id="searchInput" placeholder="이름이나 이메일로 검색..." style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <button class="btn btn-primary" onclick="exportMembers()">
                    <i class="fas fa-download"></i> 회원 목록 내보내기
                </button>
            </div>
        </header>

        <!-- 회원 관리 컨텐츠 -->
        <div class="dashboard-content">
            <!-- 통계 카드 -->
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>총 회원수</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="stat-info">
                        <h3>신규 회원 (이번 달)</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>활성 회원</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3>투자 회원</h3>
                        <p class="stat-number">0</p>
                    </div>
                </div>
            </div>

            <!-- 회원 목록 -->
            <div class="admin-table">
                <table id="memberTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 0)">ID</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 1)">이름</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 2)">아이디</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 3)">연락처</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 4)">권한</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 5)">가입일</th>
                            <th onclick="sortTable(this.parentNode.parentNode.parentNode, 6)">상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="memberTableBody">
                        <!-- JavaScript로 동적 생성 -->
                    </tbody>
                </table>
            </div>

            <!-- 페이지네이션 -->
            <div id="paginationContainer"></div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // 로그인 체크
        checkAdminAuth();
        
        // 관리자 정보 표시
        const currentAdmin = getCurrentAdmin();
        if (currentAdmin) {
            document.getElementById('adminInfo').textContent = `${currentAdmin.name}님 환영합니다`;
        }

        // 회원 데이터 (실제 환경에서는 서버에서 가져와야 함)
        let members = [
            {
                id: 1,
                name: "김민정",
                username: "minj0010",
                email: "minj0010@hanyang-energy.com",
                phone: "010-3234-1123",
                joinDate: "2024-03-15",
                status: "active",
                role: "admin",
                investmentAmount: 65000000,
                bankName: "KB국민은행",
                accountNumber: "94401139100103",
                address: "서울 강남구 도산대로 104 (논현동)",
                detailAddress: "원경빌301"
            }
        ];

        // 통계 업데이트 함수
        function updateMemberStats() {
            // 총 회원수
            document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = members.length;
            
            // 신규 회원 (이번 달) - 2024년 3월 기준
            const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM 형식
            const newMembersThisMonth = members.filter(member => member.joinDate.startsWith('2024-03')).length;
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = newMembersThisMonth;
            
            // 활성 회원
            const activeMembers = members.filter(member => member.status === 'active').length;
            document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = activeMembers;
            
            // 투자 회원 (투자금액이 있는 회원)
            const investmentMembers = members.filter(member => member.investmentAmount && member.investmentAmount > 0).length;
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = investmentMembers;
        }

        // 회원 목록 렌더링
        function renderMemberTable() {
            const tbody = document.getElementById('memberTableBody');
            tbody.innerHTML = '';

            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">등록된 회원이 없습니다.</td></tr>';
                return;
            }

            members.forEach(member => {
                const row = document.createElement('tr');
                const statusClass = member.status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = member.status === 'active' ? '활성' : '비활성';
                const roleClass = member.role === 'admin' ? 'role-admin' : 'role-user';
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                
                row.innerHTML = `
                    <td>${member.id}</td>
                    <td>${member.name}</td>
                    <td>${member.username}</td>
                    <td>${member.phone}</td>
                    <td>
                        <span class="role-badge ${roleClass}">
                            ${roleText}
                        </span>
                    </td>
                    <td>${member.joinDate}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewMember(${member.id})">
                            <i class="fas fa-eye"></i> 상세보기
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="toggleMemberStatus(${member.id})">
                            <i class="fas fa-user-cog"></i> 상태변경
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 회원 상세보기
        function viewMember(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                const roleText = member.role === 'admin' ? '관리자' : '사용자';
                alert(`회원 상세 정보:\n\n이름: ${member.name}\n아이디: ${member.username}\n연락처: ${member.phone}\n권한: ${roleText}\n가입일: ${member.joinDate}\n투자금액: ${member.investmentAmount.toLocaleString()}원\n은행: ${member.bankName}\n계좌번호: ${member.accountNumber}\n주소: ${member.address} ${member.detailAddress}`);
            }
        }

        // 회원 상태 변경
        function toggleMemberStatus(id) {
            const memberIndex = members.findIndex(m => m.id === id);
            if (memberIndex !== -1) {
                const currentStatus = members[memberIndex].status;
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                const statusText = newStatus === 'active' ? '활성화' : '비활성화';
                
                confirmAction(`이 회원을 ${statusText}하시겠습니까?`, () => {
                    members[memberIndex].status = newStatus;
                    renderMemberTable();
                    showAlert('success', `회원이 성공적으로 ${statusText}되었습니다.`);
                });
            }
        }

        // 회원 목록 내보내기
        function exportMembers() {
            const csv = generateMemberCSV();
            downloadCSV(csv, 'members.csv');
            showAlert('success', '회원 목록이 성공적으로 내보내졌습니다.');
        }

        // CSV 생성
        function generateMemberCSV() {
            const headers = ['ID', '이름', '이메일', '연락처', '가입일', '상태', '투자금액'];
            const rows = members.map(member => [
                member.id,
                member.name,
                member.email,
                member.phone,
                member.joinDate,
                member.status === 'active' ? '활성' : '비활성',
                member.investmentAmount
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // CSV 다운로드
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateMemberStats();
            renderMemberTable();
            
            // 검색 기능 설정
            const searchInput = document.getElementById('searchInput');
            const table = document.getElementById('memberTable');
            setupTableSearch(searchInput, table);
        });

        // Helper 함수들
        function showAlert(type, message) {
            alert(message);
        }

        function confirmAction(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }

        function setupTableSearch(searchInput, table) {
            if (searchInput && table) {
                searchInput.addEventListener('input', function() {
                    const filter = this.value.toLowerCase();
                    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                    
                    for (let i = 0; i < rows.length; i++) {
                        const cells = rows[i].getElementsByTagName('td');
                        let found = false;
                        
                        for (let j = 1; j < 4; j++) { // 이름, 아이디, 연락처 검색
                            if (cells[j] && cells[j].textContent.toLowerCase().includes(filter)) {
                                found = true;
                                break;
                            }
                        }
                        
                        rows[i].style.display = found ? '' : 'none';
                    }
                });
            }
        }
    </script>

    <style>
        /* 상태 배지 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* 권한 배지 */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-admin {
            background: #ffeaa7;
            color: #856404;
        }

        .role-user {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* 버튼 크기 */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }

        /* 관리자 정보 스타일 */
        .admin-info {
            color: #2c3e50;
            font-weight: 500;
            margin-right: 15px;
            padding: 8px 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 5px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* 버튼 크기 */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }

        /* 테이블 헤더 정렬 가능 표시 */
        th {
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #e9ecef;
        }
    </style>
</body>
</html>
